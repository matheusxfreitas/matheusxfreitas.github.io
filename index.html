<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle de Estudos - Psic√≥logo Uberl√¢ndia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Warm Harmony -->
    <!-- Application Structure Plan: A dashboard-style SPA with a weekly planner focus. Key metrics and a progress chart provide at-a-glance motivation. A tabbed daily view keeps the UI clean and focused. Users interact by switching days and checking off tasks, which dynamically updates the progress chart. This structure was chosen to transform a static plan into an active, engaging tracking tool, prioritizing clarity and user motivation. Gemini API features (question generation, topic explanation) are integrated via modals triggered from task cards, enhancing the study loop. -->
    <!-- Visualization & Content Choices: 1. Countdown (JS Text): Goal=Motivate, Justification=Urgency. 2. Weekly Planner (HTML/JS Tabs): Goal=Organize, Justification=Clarity/Focus. 3. Progress Tracker (Chart.js Donut): Goal=Inform/Motivate, Interaction=Updates on task completion, Justification=Clear visual feedback. 4. Task Icons (Unicode): Goal=Inform, Justification=Scannability. 5. Gemini Features (Modal): Goal=Enhance/Deepen Study, Interaction=Button click on tasks, Justification=Provides on-demand practice and clarification without cluttering the main UI. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDFBF8; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { transition: all 0.2s ease; position: relative; }
        .calendar-day:hover { background-color: #f7f3ef; }
        .calendar-day.has-task::after { content: ''; display: block; width: 6px; height: 6px; border-radius: 50%; background-color: #D5A021; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
        .calendar-day.selected { background-color: #D5A021; color: white; font-weight: bold; }
        .task-card { background-color: #FFFFFF; border-left: 4px solid #D6BFAA; transition: box-shadow 0.3s ease; }
        .task-card.review-r1 { border-left-color: #6A9C89; }
        .task-card.review-r3 { border-left-color: #D5A021; }
        .task-card.review-r5 { border-left-color: #A25B5B; }
        .task-card.overdue { border-left-color: #ef4444; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .task-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .task-checkbox:checked + label { text-decoration: line-through; color: #9A9A9A; }
        .chart-container { position: relative; width: 100%; max-width: 250px; margin-left: auto; margin-right: auto; height: 250px; }
        .gemini-button { background-color: #f0e9e0; color: #8a6c3a; transition: all 0.2s ease-in-out; }
        .gemini-button:hover { background-color: #e9dccf; transform: translateY(-1px); }
        .modal.hidden { display: none; }
        .modal-content { white-space: pre-wrap; }
        .control-button { background-color: #fff; border: 1px solid #ddd; transition: all 0.2s ease; }
        .control-button:hover { background-color: #f9f9f9; border-color: #ccc; }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="mb-8">
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Meu Painel de Estudos 2.0</h1>
                <p class="text-lg text-gray-600 mt-2">Miss√£o: Aprova√ß√£o Psic√≥logo(a) - Prefeitura de Uberl√¢ndia</p>
            </div>
            <div class="mt-6 flex flex-wrap justify-center gap-2">
                <button id="view-overdue-tasks-btn" class="control-button text-sm font-semibold py-2 px-4 rounded-lg shadow-sm text-red-600 border-red-300">Visualizar Aulas Atrasadas</button>
                <button id="view-all-tasks-btn" class="control-button text-sm font-semibold py-2 px-4 rounded-lg shadow-sm">Visualizar Aulas Cadastradas</button>
                <button id="export-backup-btn" class="control-button text-sm font-semibold py-2 px-4 rounded-lg shadow-sm">Exportar Backup (Progresso)</button>
                <button id="import-backup-btn" class="control-button text-sm font-semibold py-2 px-4 rounded-lg shadow-sm">Importar Backup (Progresso)</button>
                <input type="file" id="import-backup-file" class="hidden" accept=".json">
                <button id="export-csv-btn" class="control-button text-sm font-semibold py-2 px-4 rounded-lg shadow-sm">Exportar Aulas (CSV)</button>
                <button id="import-csv-btn" class="control-button text-sm font-semibold py-2 px-4 rounded-lg shadow-sm">Importar Novas Aulas (CSV)</button>
                <input type="file" id="import-csv-file" class="hidden" accept=".csv">
                <button id="reset-btn" class="control-button text-sm font-semibold py-2 px-4 rounded-lg shadow-sm text-red-600">Resetar Progresso</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                <h3 class="font-semibold text-gray-500 mb-2">Contagem Regressiva</h3>
                <div id="countdown" class="text-2xl font-bold text-[#4A4A4A]"></div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                <h3 class="font-semibold text-gray-500 mb-2">Data da Prova</h3>
                <p class="text-2xl font-bold text-[#4A4A4A]">26/10/2025</p>
            </div>
            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                <h3 class="font-semibold text-gray-500 mb-2">Progresso Geral</h3>
                <p id="progressText" class="text-2xl font-bold text-[#4A4A4A]">0%</p>
            </div>
             <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                <h3 class="font-semibold text-gray-500 mb-2">Hoje √©</h3>
                <p id="currentDate" class="text-xl font-bold text-[#4A4A4A] text-center"></p>
            </div>
        </div>

        <main class="bg-white p-4 sm:p-6 rounded-lg shadow-md border border-gray-200">
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="w-full lg:w-2/3">
                    <div id="calendar-container"></div>
                    <div id="plan-content" class="space-y-4 mt-6"></div>
                </div>

                <aside class="w-full lg:w-1/3 lg:border-l lg:pl-8 border-gray-200">
                    <div class="sticky top-8">
                        <h2 class="text-2xl font-bold mb-4 text-center">Progresso Geral</h2>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                        <div class="mt-8 p-4 rounded-lg bg-gray-50 border">
                            <h3 class="font-bold text-lg mb-2">Legenda de Revis√µes</h3>
                             <div class="flex items-center space-x-2 text-sm"><div class="w-4 h-4 rounded-full bg-[#6A9C89]"></div><span>R1 (D+1) - R√°pida</span></div>
                             <div class="flex items-center space-x-2 text-sm"><div class="w-4 h-4 rounded-full bg-[#D5A021]"></div><span>R3 (D+7) - Intermedi√°ria</span></div>
                             <div class="flex items-center space-x-2 text-sm"><div class="w-4 h-4 rounded-full bg-[#A25B5B]"></div><span>R5 (D+30) - Longo Prazo</span></div>
                             <div class="flex items-center space-x-2 text-sm"><div class="w-4 h-4 rounded-full bg-red-500"></div><span>Tarefa Atrasada</span></div>
                        </div>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <div id="geminiModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modalTitle" class="text-xl font-bold">Assistente de Estudos ‚ú®</h3>
                <button class="close-modal text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="modalLoading" class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                    <p class="mt-4 text-gray-600">Gerando conte√∫do... Por favor, aguarde.</p>
                </div>
                <div id="modalContent" class="modal-content"></div>
            </div>
        </div>
    </div>

    <div id="allTasksModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">Todas as Aulas Cadastradas</h3>
                <button class="close-modal text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="p-4">
                <input type="text" id="all-tasks-search" class="w-full p-2 border rounded-md" placeholder="Buscar por mat√©ria ou t√≥pico...">
            </div>
            <div class="p-4 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mat√©ria</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aula</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√≥pico</th>
                        </tr>
                    </thead>
                    <tbody id="all-tasks-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
// =================== IN√çCIO DO C√ìDIGO CORRIGIDO ===================
    const firebaseConfig = {
        apiKey: "AIzaSyAVd3uPqsJdyi1a3VYZbncrLZeq7zF-vNE",
        authDomain: "meu-painel-de-estudos-5d0ee.firebaseapp.com",
        projectId: "meu-painel-de-estudos-5d0ee",
        storageBucket: "meu-painel-de-estudos-5d0ee.appspot.com",
        messagingSenderId: "700808378235",
        appId: "1:700808378235:web:64bc3701361324c2c36fde"
    };

    // CORRE√á√ÉO 1: A chamada de inicializa√ß√£o foi corrigida para o formato da v8 (firebase.initializeApp)
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); // Nosso banco de dados!

    const STORAGE_KEY = 'studyPlanProgress_psicologoUdi_v5';
    let viewDate = new Date();
    viewDate.setHours(0, 0, 0, 0);
    
    let studyPlan = {};

    const planContent = document.getElementById('plan-content');
    const progressText = document.getElementById('progressText');
    const geminiModal = document.getElementById('geminiModal');
    const allTasksModal = document.getElementById('allTasksModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const modalLoading = document.getElementById('modalLoading');
    let progressChart;

    function formatDateYMD(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDateDMY(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    function addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }

    function subDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() - days);
        return result;
    }
    
    function isSameDay(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getDate() === date2.getDate();
    }

    function isBefore(date1, date2) {
        const d1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const d2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
        return d1.getTime() < d2.getTime();
    }

    function generateUniqueId(task) {
         return `${task.subject.replace(/[^a-zA-Z0-9]/g, '')}-${task.lesson.replace(/[^a-zA-Z0-9]/g, '')}-${task.type}`;
    }

    function initializeStudyPlan() {
        let plan = { tasks: {}, reviews: {} };
        
        const allTasks = [
                // --- DIA 10 - DOMINGO ---
            { date: '2025-08-10', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '9', topic: 'Psicologia Social', type: 'pdf' },
            { date: '2025-08-10', subject: 'L√≠ngua Portuguesa', lesson: '6', topic: 'A Sintaxe do Per√≠odo Composto', type: 'pdf' },

            // --- DIA 11 - SEGUNDA-FEIRA ---
            { date: '2025-08-11', subject: 'L√≠ngua Portuguesa', lesson: '6', topic: 'A Sintaxe do Per√≠odo Composto', type: 'pdf' },

            // --- DIA 12 - TER√áA-FEIRA ---
            { date: '2025-08-12', subject: 'L√≠ngua Portuguesa', lesson: '6', topic: 'A Sintaxe do Per√≠odo Composto', type: 'pdf' },
            { date: '2025-08-12', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '44', topic: 'Decreto 7.508/11 - Quest√µes - Parte 1', type: 'video' },
            { date: '2025-08-12', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '45', topic: 'Decreto 7.508/11 - Arts. 3 a 7', type: 'video' },
            { date: '2025-08-12', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '46', topic: 'Decreto 7.508/11 - Quest√µes - Parte 2', type: 'video' },
            { date: '2025-08-12', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '47', topic: 'Decreto 7.508/11 - Arts. 8 a 14', type: 'video' },
            { date: '2025-08-12', subject: 'L√≠ngua Portuguesa', lesson: '17', topic: 'Fun√ß√µes Sint√°ticas dos Pronomes Pessoais Obl√≠quos', type: 'video' },
            { date: '2025-08-12', subject: 'L√≠ngua Portuguesa', lesson: '1', topic: 'Reg√™ncia Verbal e Nominal', type: 'video' },
            { date: '2025-08-12', subject: 'L√≠ngua Portuguesa', lesson: '2', topic: 'Reg√™ncia Verbal e Nominal II', type: 'video' },
            { date: '2025-08-12', subject: 'L√≠ngua Portuguesa', lesson: '3', topic: 'Reg√™ncia Verbal e Nominal III', type: 'video' },

            // --- DIA 13 - QUARTA-FEIRA ---
            { date: '2025-08-13', subject: 'L√≠ngua Portuguesa', lesson: '3', topic: 'Reg√™ncia Verbal e Nominal III', type: 'video' },
            { date: '2025-08-13', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '10', topic: 'Avalia√ß√£o Psicol√≥gica ‚Äì Parte I', type: 'pdf' },
            { date: '2025-08-13', subject: 'L√≠ngua Portuguesa', lesson: '7', topic: 'Concord√¢ncia, Reg√™ncia, Coloca√ß√£o, Crase e Pontua√ß√£o', type: 'pdf' },
            
            // --- DIA 14 - QUINTA-FEIRA ---
            { date: '2025-08-14', subject: 'L√≠ngua Portuguesa', lesson: '7', topic: 'Concord√¢ncia, Reg√™ncia, Coloca√ß√£o, Crase e Pontua√ß√£o', type: 'pdf' },
            { date: '2025-08-14', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '48', topic: 'Decreto 7.508/11 - Quest√µes', type: 'video' },
            { date: '2025-08-14', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '49', topic: 'Decreto 7.508/11 - Arts. 15 ao 25', type: 'video' },

            // --- DIA 15 - SEXTA-FEIRA ---
            { date: '2025-08-15', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '49', topic: 'Decreto 7.508/11 - Arts. 15 ao 25', type: 'video' },
            { date: '2025-08-15', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '50', topic: 'Decreto 7.508/11 - Arts. 26 a 30', type: 'video' },
            { date: '2025-08-15', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '51', topic: 'Decreto 7.508/11 - Arts. 31 a 44', type: 'video' },
            { date: '2025-08-15', subject: 'L√≠ngua Portuguesa', lesson: '1', topic: 'Emprego do Sinal Indicativo de Crase', type: 'video' },
            { date: '2025-08-15', subject: 'L√≠ngua Portuguesa', lesson: '2', topic: 'Emprego do Sinal Indicativo de Crase II', type: 'video' },
            { date: '2025-08-15', subject: 'L√≠ngua Portuguesa', lesson: '3', topic: 'Emprego do Sinal Indicativo de Crase III', type: 'video' },
            { date: '2025-08-15', subject: 'L√≠ngua Portuguesa', lesson: '1', topic: 'Coordena√ß√£o Vs Subordina√ß√£o', type: 'video' },

            // --- DIA 16 - S√ÅBADO ---
            { date: '2025-08-16', subject: 'L√≠ngua Portuguesa', lesson: '1', topic: 'Coordena√ß√£o Vs Subordina√ß√£o', type: 'video' },
            { date: '2025-08-16', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '11', topic: 'Avalia√ß√£o Psicol√≥gica ‚Äì Parte II', type: 'pdf' },

            // --- DIA 17 - DOMINGO ---
            { date: '2025-08-17', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '11', topic: 'Avalia√ß√£o Psicol√≥gica ‚Äì Parte II', type: 'pdf' },
            { date: '2025-08-17', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '52', topic: 'Decreto 7.508/11 - Quest√µes', type: 'video' },
            { date: '2025-08-17', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '53', topic: 'Decreto 7.508/11 - Quest√µes II', type: 'video' },
            { date: '2025-08-17', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '54', topic: 'Decreto 7.508/11 - Quest√µes III', type: 'video' },
            { date: '2025-08-17', subject: 'Conhecimentos Espec√≠ficos do Cargo', lesson: '1', topic: 'Estatuto do Idoso - Lei n¬∫ 10.741/2003 I', type: 'video' },
            { date: '2025-08-17', subject: 'L√≠ngua Portuguesa', lesson: '2', topic: 'Per√≠odo Composto - Ora√ß√£o Subordinada Adjetiva', type: 'video' },
            { date: '2025-08-17', subject: 'L√≠ngua Portuguesa', lesson: '3', topic: 'Per√≠odo Composto - Ora√ß√£o Subordinada Adjetiva e Fun√ß√£o Sint√°tica do Pronome Relativo', type: 'video' },
            { date: '2025-08-18', subject: 'L√≠ngua Portuguesa', lesson: '4', topic: 'Per√≠odo Composto - Ora√ß√£o Subordinada Substantiva', type: 'video' },
            { date: '2025-08-18', subject: 'L√≠ngua Portuguesa', lesson: '5', topic: 'Per√≠odo Composto - Ora√ß√£o Subordinada Adverbial', type: 'video' },
            { date: '2025-08-18', subject: 'Conhecimentos Espec√≠ficos', lesson: '12', topic: 'Psicologia da Sa√∫de e Interven√ß√µes', type: 'pdf' },
            { date: '2025-08-18', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '1', topic: 'Operadores L√≥gicos Fundamentais', type: 'pdf' },
            { date: '2025-08-19', subject: 'Conhecimentos Espec√≠ficos', lesson: '2', topic: 'Estatuto do Idoso - Lei n¬∫ 10.741/2003 II', type: 'video' },
            { date: '2025-08-19', subject: 'Conhecimentos Espec√≠ficos', lesson: '3', topic: 'Estatuto do Idoso - Lei n¬∫ 10.741/2003 III', type: 'video' },
            { date: '2025-08-19', subject: 'Conhecimentos Espec√≠ficos', lesson: '4', topic: 'Estatuto do Idoso - Lei n¬∫ 10.741/2003 IV', type: 'video' },
            { date: '2025-08-19', subject: 'Conhecimentos Espec√≠ficos', lesson: '5', topic: 'Estatuto do Idoso - Lei n¬∫ 10.741/2003 V', type: 'video' },
            { date: '2025-08-19', subject: 'L√≠ngua Portuguesa', lesson: '6', topic: 'Per√≠odo Composto - Ora√ß√£o Subordinada Adverbial II', type: 'video' },
            { date: '2025-08-19', subject: 'L√≠ngua Portuguesa', lesson: '7', topic: 'Per√≠odo Composto - Ora√ß√µes Reduzidas', type: 'video' },
            { date: '2025-08-19', subject: 'L√≠ngua Portuguesa', lesson: '8', topic: 'Per√≠odo Composto - Ora√ß√µes Coordenadas', type: 'video' },
            { date: '2025-08-19', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '1', topic: 'Operadores L√≥gicos Fundamentais', type: 'pdf' },
            { date: '2025-08-19', subject: 'Administra√ß√£o P√∫blica', lesson: '1', topic: 'Princ√≠pios Fundamentais', type: 'pdf' },
            { date: '2025-08-20', subject: 'L√≠ngua Portuguesa', lesson: '9', topic: 'Per√≠odo Composto - Ora√ß√µes Coordenadas II', type: 'video' },
            { date: '2025-08-20', subject: 'Conhecimentos Espec√≠ficos', lesson: '13', topic: 'Psicologia Organizacional - Parte I', type: 'pdf' },
            { date: '2025-08-20', subject: 'Administra√ß√£o P√∫blica', lesson: '1', topic: 'Princ√≠pios Fundamentais', type: 'pdf' },
            { date: '2025-08-20', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '2', topic: 'Operador Condicional', type: 'pdf' },
            { date: '2025-08-21', subject: 'Conhecimentos Espec√≠ficos', lesson: '6', topic: 'Estatuto do Idoso - Lei n¬∫ 10.741/2003 VI', type: 'video' },
            { date: '2025-08-21', subject: 'Conhecimentos Espec√≠ficos', lesson: '7', topic: 'Estatuto do Idoso - Lei n¬∫ 10.741/2003 VII', type: 'video' },
            { date: '2025-08-21', subject: 'Conhecimentos Espec√≠ficos', lesson: '8', topic: 'Estatuto do Idoso - Resumo e Jurisprud√™ncia', type: 'video' },
            { date: '2025-08-21', subject: 'Conhecimentos Espec√≠ficos', lesson: '9', topic: 'Estatuto do Idoso - Exerc√≠cios', type: 'video' },
            { date: '2025-08-21', subject: 'L√≠ngua Portuguesa', lesson: '10', topic: 'Fun√ß√µes do SE', type: 'video' },
            { date: '2025-08-21', subject: 'L√≠ngua Portuguesa', lesson: '1', topic: 'Pontua√ß√£o', type: 'video' },
            { date: '2025-08-21', subject: 'Conhecimentos Espec√≠ficos', lesson: '13', topic: 'Psicologia Organizacional - Parte I', type: 'pdf' },
            { date: '2025-08-21', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '2', topic: 'Operador Condicional', type: 'pdf' },
            { date: '2025-08-22', subject: 'L√≠ngua Portuguesa', lesson: '2', topic: 'Pontua√ß√£o II', type: 'video' },
            { date: '2025-08-22', subject: 'L√≠ngua Portuguesa', lesson: '3', topic: 'Pontua√ß√£o III', type: 'video' },
            { date: '2025-08-22', subject: 'Conhecimentos Espec√≠ficos', lesson: '14', topic: 'Psicologia Organizacional - Parte II', type: 'pdf' },
            { date: '2025-08-22', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '2', topic: 'Operador Condicional', type: 'pdf' },
            { date: '2025-08-22', subject: 'Administra√ß√£o P√∫blica', lesson: '2', topic: 'Direitos e Deveres Individuais e Coletivos', type: 'pdf' },
            { date: '2025-08-23', subject: 'Conhecimentos Espec√≠ficos', lesson: '14', topic: 'Psicologia Organizacional - Parte II', type: 'pdf' },
            { date: '2025-08-23', subject: 'Conhecimentos Espec√≠ficos', lesson: '10', topic: 'Estatuto do Idoso - Exerc√≠cios II', type: 'video' },
            { date: '2025-08-23', subject: 'Conhecimentos Espec√≠ficos', lesson: '1', topic: 'Lei n¬∫ 13.146/15 - Disposi√ß√µes Gerais', type: 'video' },
            { date: '2025-08-23', subject: 'Conhecimentos Espec√≠ficos', lesson: '2', topic: 'Lei n¬∫ 13.146/15 - Disposi√ß√µes Gerais II', type: 'video' },
            { date: '2025-08-23', subject: 'Conhecimentos Espec√≠ficos', lesson: '3', topic: 'Lei n¬∫ 13.146/15 - Igualdade e N√£o Discrimina√ß√£o', type: 'video' },
            { date: '2025-08-23', subject: 'L√≠ngua Portuguesa', lesson: '4', topic: 'Pontua√ß√£o IV', type: 'video' },
            { date: '2025-08-23', subject: 'L√≠ngua Portuguesa', lesson: '1', topic: 'Concord√¢ncia Verbal', type: 'video' },
            { date: '2025-08-25', subject: 'Conhecimentos Espec√≠ficos', lesson: '15', topic: 'Gest√£o de Pessoas nas Organiza√ß√µes P√∫blicas e Privadas', type: 'pdf' },
            { date: '2025-08-25', subject: 'Conhecimentos Espec√≠ficos', lesson: '4', topic: 'Lei n¬∫ 13.146/15 - Direito √† Vida, Habilita√ß√£o e Reabilita√ß√£o', type: 'video' },
            { date: '2025-08-25', subject: 'Conhecimentos Espec√≠ficos', lesson: '5', topic: 'Lei n¬∫ 13.146/15 - Direito √† Sa√∫de', type: 'video' },
            { date: '2025-08-25', subject: 'Administra√ß√£o P√∫blica', lesson: '2', topic: 'Direitos e Deveres Individuais e Coletivos', type: 'pdf' },
            { date: '2025-08-26', subject: 'L√≠ngua Portuguesa', lesson: '2', topic: 'Concord√¢ncia Verbal II', type: 'video' },
            { date: '2025-08-26', subject: 'L√≠ngua Portuguesa', lesson: '3', topic: 'Concord√¢ncia Verbal III', type: 'video' },
            { date: '2025-08-26', subject: 'Conhecimentos Espec√≠ficos', lesson: '6', topic: 'Lei n¬∫ 13.146/15 - Direito √† Educa√ß√£o', type: 'video' },
            { date: '2025-08-26', subject: 'Conhecimentos Espec√≠ficos', lesson: '7', topic: 'Lei n¬∫ 13.146/15 - Direito √† Moradia e Trabalho', type: 'video' },
            { date: '2025-08-26', subject: 'L√≠ngua Portuguesa', lesson: '4', topic: 'Concord√¢ncia Nominal', type: 'video' },
            { date: '2025-08-26', subject: 'Administra√ß√£o P√∫blica', lesson: '2', topic: 'Direitos e Deveres Individuais e Coletivos', type: 'pdf' },
            { date: '2025-08-26', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '3', topic: 'L√≥gica de Argumenta√ß√£o', type: 'pdf' },
            { date: '2025-08-27', subject: 'L√≠ngua Portuguesa', lesson: '1', topic: 'Significa√ß√£o Literal e Contextual', type: 'video' },
            { date: '2025-08-27', subject: 'L√≠ngua Portuguesa', lesson: '2', topic: 'Campos Sem√¢nticos e Campos Lexicais', type: 'video' },
            { date: '2025-08-27', subject: 'L√≠ngua Portuguesa', lesson: '1', topic: 'Figuras de Linguagem - Denota√ß√£o, Conota√ß√£o', type: 'video' },
            { date: '2025-08-27', subject: 'Conhecimentos Espec√≠ficos', lesson: '16', topic: 'Psicodin√¢mica do Trabalho', type: 'pdf' },
            { date: '2025-08-27', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '3', topic: 'L√≥gica de Argumenta√ß√£o', type: 'pdf' },
            { date: '2025-08-27', subject: 'Administra√ß√£o P√∫blica', lesson: '3', topic: 'Direitos Sociais', type: 'pdf' },
            { date: '2025-08-28', subject: 'Conhecimentos Espec√≠ficos', lesson: '16', topic: 'Psicodin√¢mica do Trabalho', type: 'pdf' },
            { date: '2025-08-28', subject: 'Conhecimentos Espec√≠ficos', lesson: '8', topic: 'Lei n¬∫ 13.146/15 - Direito √† Assist√™ncia e Previd√™ncia Social', type: 'video' },
            { date: '2025-08-28', subject: 'Conhecimentos Espec√≠ficos', lesson: '9', topic: 'Lei n¬∫ 13.146/15 - Acessibilidade', type: 'video' },
            { date: '2025-08-28', subject: 'Conhecimentos Espec√≠ficos', lesson: '10', topic: 'Lei n¬∫ 13.146/15 - Acesso √† Informa√ß√£o e Comunica√ß√£o', type: 'video' },
            { date: '2025-08-28', subject: 'Conhecimentos Espec√≠ficos', lesson: '11', topic: 'Lei n¬∫ 13.146/15 - Tecnologia Assistiva', type: 'video' },
            { date: '2025-08-28', subject: 'L√≠ngua Portuguesa', lesson: '2', topic: 'Figuras de Linguagem II', type: 'video' },
            { date: '2025-08-28', subject: 'L√≠ngua Portuguesa', lesson: '3', topic: 'Figuras de Linguagem III', type: 'video' },
            { date: '2025-08-28', subject: 'L√≠ngua Portuguesa', lesson: '1', topic: 'Compreens√£o e Interpreta√ß√£o', type: 'video' },
            { date: '2025-08-28', subject: 'L√≠ngua Portuguesa', lesson: '1', topic: 'Tipologia e G√™neros Textuais', type: 'video' },
            { date: '2025-08-28', subject: 'Administra√ß√£o P√∫blica', lesson: '3', topic: 'Direitos Sociais', type: 'pdf' },
            { date: '2025-08-29', subject: 'Conhecimentos Espec√≠ficos', lesson: '17', topic: 'Estatuto da Crian√ßa e do Adolescente - Parte Geral', type: 'pdf' },
            { date: '2025-08-29', subject: 'Administra√ß√£o P√∫blica', lesson: '3', topic: 'Direitos Sociais', type: 'pdf' },
            { date: '2025-08-29', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '4', topic: 'Raz√£o, Propor√ß√£o, Regra de Tr√™s e Porcentagem', type: 'pdf' },
            { date: '2025-09-01', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '4', topic: 'Raz√£o, Propor√ß√£o, Regra de Tr√™s e Porcentagem', type: 'pdf' },
            { date: '2025-09-01', subject: 'Administra√ß√£o P√∫blica', lesson: '4', topic: 'Nacionalidade', type: 'pdf' },
            { date: '2025-09-02', subject: 'Administra√ß√£o P√∫blica', lesson: '4', topic: 'Nacionalidade', type: 'pdf' },
            { date: '2025-09-02', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '5', topic: 'Fun√ß√µes e Gr√°ficos do 1¬∫ Grau', type: 'pdf' },
            { date: '2025-09-03', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '5', topic: 'Fun√ß√µes e Gr√°ficos do 1¬∫ Grau', type: 'pdf' },
            { date: '2025-09-04', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '5', topic: 'Fun√ß√µes e Gr√°ficos do 1¬∫ Grau', type: 'pdf' },
            { date: '2025-09-04', subject: 'Administra√ß√£o P√∫blica', lesson: '5', topic: 'Direitos Pol√≠ticos e Partidos Pol√≠ticos', type: 'pdf' },
            { date: '2025-09-05', subject: 'Administra√ß√£o P√∫blica', lesson: '5', topic: 'Direitos Pol√≠ticos e Partidos Pol√≠ticos', type: 'pdf' },
            { date: '2025-09-05', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '6', topic: 'Fun√ß√µes e Gr√°ficos do 2¬∫ Grau', type: 'pdf' },
            { date: '2025-09-08', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '6', topic: 'Fun√ß√µes e Gr√°ficos do 2¬∫ Grau', type: 'pdf' },
            { date: '2025-09-08', subject: 'Administra√ß√£o P√∫blica', lesson: '6', topic: 'Organiza√ß√£o Pol√≠tico-Administrativa do Estado', type: 'pdf' },
            { date: '2025-09-09', subject: 'Administra√ß√£o P√∫blica', lesson: '6', topic: 'Organiza√ß√£o Pol√≠tico-Administrativa do Estado', type: 'pdf' },
            { date: '2025-09-10', subject: 'Administra√ß√£o P√∫blica', lesson: '6', topic: 'Organiza√ß√£o Pol√≠tico-Administrativa do Estado', type: 'pdf' },
            { date: '2025-09-10', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '7', topic: 'An√°lise Combinat√≥ria', type: 'pdf' },
            { date: '2025-09-11', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '7', topic: 'An√°lise Combinat√≥ria', type: 'pdf' },
            { date: '2025-09-11', subject: 'Administra√ß√£o P√∫blica', lesson: '7', topic: 'Reparti√ß√£o de Compet√™ncias', type: 'pdf' },
            { date: '2025-09-12', subject: 'Administra√ß√£o P√∫blica', lesson: '7', topic: 'Reparti√ß√£o de Compet√™ncias', type: 'pdf' },
            { date: '2025-09-12', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '8', topic: 'Probabilidades', type: 'pdf' },
            { date: '2025-09-15', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '8', topic: 'Probabilidades', type: 'pdf' },
            { date: '2025-09-16', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '8', topic: 'Probabilidades', type: 'pdf' },
            { date: '2025-09-16', subject: 'Administra√ß√£o P√∫blica', lesson: '8', topic: 'Administra√ß√£o P√∫blica', type: 'pdf' },
            { date: '2025-09-17', subject: 'Administra√ß√£o P√∫blica', lesson: '8', topic: 'Administra√ß√£o P√∫blica', type: 'pdf' },
            { date: '2025-09-17', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '9', topic: 'Progress√µes Aritm√©ticas e Geom√©tricas', type: 'pdf' },
            { date: '2025-09-18', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '9', topic: 'Progress√µes Aritm√©ticas e Geom√©tricas', type: 'pdf' },
            { date: '2025-09-18', subject: 'Administra√ß√£o P√∫blica', lesson: '1', topic: 'Organiza√ß√£o Administrativa', type: 'pdf' },
            { date: '2025-09-19', subject: 'Administra√ß√£o P√∫blica', lesson: '1', topic: 'Organiza√ß√£o Administrativa', type: 'pdf' },
            { date: '2025-09-22', subject: 'Administra√ß√£o P√∫blica', lesson: '1', topic: 'Organiza√ß√£o Administrativa', type: 'pdf' },
            { date: '2025-09-22', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '10', topic: 'N√∫meros Inteiros', type: 'pdf' },
            { date: '2025-09-23', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '10', topic: 'N√∫meros Inteiros', type: 'pdf' },
            { date: '2025-09-23', subject: 'Administra√ß√£o P√∫blica', lesson: '2', topic: 'Lei de Improbidade Administrativa', type: 'pdf' },
            { date: '2025-09-24', subject: 'Administra√ß√£o P√∫blica', lesson: '2', topic: 'Lei de Improbidade Administrativa', type: 'pdf' },
            { date: '2025-09-24', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '11', topic: 'N√∫meros Racionais e Reais', type: 'pdf' },
            { date: '2025-09-25', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '11', topic: 'N√∫meros Racionais e Reais', type: 'pdf' },
            { date: '2025-09-25', subject: 'Administra√ß√£o P√∫blica', lesson: '3', topic: 'Lei n¬∫ 14.133/2021 - Licita√ß√£o', type: 'pdf' },
            { date: '2025-09-26', subject: 'Administra√ß√£o P√∫blica', lesson: '3', topic: 'Lei n¬∫ 14.133/2021 - Licita√ß√£o', type: 'pdf' },
            { date: '2025-09-29', subject: 'Administra√ß√£o P√∫blica', lesson: '3', topic: 'Lei n¬∫ 14.133/2021 - Licita√ß√£o', type: 'pdf' },
            { date: '2025-09-30', subject: 'Administra√ß√£o P√∫blica', lesson: '3', topic: 'Lei n¬∫ 14.133/2021 - Licita√ß√£o', type: 'pdf' },
            { date: '2025-09-30', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '12', topic: 'Geometria Plana: √Åreas', type: 'pdf' },
            { date: '2025-10-01', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '12', topic: 'Geometria Plana: √Åreas', type: 'pdf' },
            { date: '2025-10-01', subject: 'Administra√ß√£o P√∫blica', lesson: '4', topic: 'Lei n¬∫ 12.527/2011 - Acesso √† Informa√ß√£o', type: 'pdf' },
            { date: '2025-10-02', subject: 'Administra√ß√£o P√∫blica', lesson: '4', topic: 'Lei n¬∫ 12.527/2011 - Acesso √† Informa√ß√£o', type: 'pdf' },
            { date: '2025-10-02', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '13', topic: 'Geometria Plana: Segmentos', type: 'pdf' },
            { date: '2025-10-03', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '13', topic: 'Geometria Plana: Segmentos', type: 'pdf' },
            { date: '2025-10-06', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '13', topic: 'Geometria Plana: Segmentos', type: 'pdf' },
            { date: '2025-10-06', subject: 'Administra√ß√£o P√∫blica', lesson: '5', topic: 'Lei n¬∫ 13.709/2018 - LGPD - Parte I', type: 'pdf' },
            { date: '2025-10-07', subject: 'Administra√ß√£o P√∫blica', lesson: '5', topic: 'Lei n¬∫ 13.709/2018 - LGPD - Parte I', type: 'pdf' },
            { date: '2025-10-07', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '14', topic: 'Trigonometria', type: 'pdf' },
            { date: '2025-10-08', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '14', topic: 'Trigonometria', type: 'pdf' },
            { date: '2025-10-08', subject: 'Administra√ß√£o P√∫blica', lesson: '6', topic: 'Lei n¬∫ 13.709/2018 - LGPD - Parte II', type: 'pdf' },
            { date: '2025-10-09', subject: 'Administra√ß√£o P√∫blica', lesson: '6', topic: 'Lei n¬∫ 13.709/2018 - LGPD - Parte II', type: 'pdf' },
            { date: '2025-10-09', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '15', topic: 'N√∫meros Complexos e Polin√¥mios', type: 'pdf' },
            { date: '2025-10-10', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '15', topic: 'N√∫meros Complexos e Polin√¥mios', type: 'pdf' },
            { date: '2025-10-10', subject: 'Administra√ß√£o P√∫blica', lesson: '7', topic: 'Lei n¬∫ 13.709/2018 - LGPD - Parte III', type: 'pdf' },
            { date: '2025-10-13', subject: 'Administra√ß√£o P√∫blica', lesson: '7', topic: 'Lei n¬∫ 13.709/2018 - LGPD - Parte III', type: 'pdf' },
            { date: '2025-10-13', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '16', topic: 'Geometria Espacial', type: 'pdf' },
            { date: '2025-10-14', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '16', topic: 'Geometria Espacial', type: 'pdf' },
            { date: '2025-10-14', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '17', topic: 'Geometria Anal√≠tica', type: 'pdf' },
            { date: '2025-10-15', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '17', topic: 'Geometria Anal√≠tica', type: 'pdf' },
            { date: '2025-10-16', subject: 'Racioc√≠nio L√≥gico-Matem√°tico', lesson: '18', topic: 'Matrizes, Determinantes e Sistemas Lineares', type: 'pdf' },
        ];

        allTasks.forEach(task => {
            const id = generateUniqueId(task);
            const dateStr = formatDateYMD(new Date(task.date + 'T00:00:00'));
            if (!plan.tasks[dateStr]) plan.tasks[dateStr] = [];
            
            const taskExists = plan.tasks[dateStr].some(t => t.id === id);
            if (!taskExists) {
                plan.tasks[dateStr].push({
                    id: id,
                    date: dateStr,
                    subject: task.subject,
                    lesson: task.lesson,
                    topic: task.topic,
                    type: 'study',
                    completed: false,
                });
            }
        });
        return plan;
    }

    const saveState = () => {
// Agora salvamos no Firestore em vez do localStorage
db.collection("progresso").doc("meuPlano").set(studyPlan)
    .then(() => {
        console.log("Progresso salvo com sucesso no Firebase!");
    })
    .catch((error) => {
        console.error("Erro ao salvar progresso: ", error);
    });
};

    const loadState = async () => {
const docRef = db.collection("progresso").doc("meuPlano");
try {
    const doc = await docRef.get();
    if (doc.exists) {
        console.log("Progresso carregado do Firebase!");
        studyPlan = doc.data();
    } else {
        // Documento n√£o existe (primeiro acesso), inicializa o plano
        console.log("Nenhum progresso encontrado, inicializando novo plano.");
        studyPlan = initializeStudyPlan();
    }
} catch (error) {
    console.error("Erro ao carregar progresso: ", error);
    // Em caso de erro, carrega o plano padr√£o para n√£o quebrar a aplica√ß√£o
    studyPlan = initializeStudyPlan();
}
};

    const renderCalendar = (date) => {
        const calendarContainer = document.getElementById('calendar-container');
        const month = date.getMonth();
        const year = date.getFullYear();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const today = new Date();
        today.setHours(0,0,0,0);

        const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        
        let html = `<div class="p-4">
            <div class="flex justify-between items-center mb-4">
                <button id="prev-month" class="control-button p-2 rounded-full">‚óÄ</button>
                <h2 class="text-xl font-bold text-center">${monthNames[month]} ${year}</h2>
                <button id="next-month" class="control-button p-2 rounded-full">‚ñ∂</button>
            </div>
            <div class="calendar-grid grid grid-cols-7 text-center font-semibold text-sm text-gray-600 mb-2">
                <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div>
            </div>
            <div class="calendar-grid grid grid-cols-7 text-center text-sm">`;

        for (let i = 0; i < firstDay.getDay(); i++) {
            html += `<div></div>`;
        }

        for (let i = 1; i <= lastDay.getDate(); i++) {
            const dayDate = new Date(year, month, i);
            const dateStr = formatDateYMD(dayDate);
            const hasTask = (studyPlan.tasks[dateStr] && studyPlan.tasks[dateStr].length > 0) || (studyPlan.reviews[dateStr] && studyPlan.reviews[dateStr].length > 0);
            
            let dayClasses = 'calendar-day cursor-pointer p-2 rounded-full aspect-square flex items-center justify-center';
            if(isSameDay(dayDate, viewDate)) dayClasses += ' selected';
            if(isSameDay(dayDate, today)) dayClasses += ' border-2 border-blue-500';
            if(hasTask) dayClasses += ' has-task';

            html += `<div class="${dayClasses}" data-date="${dateStr}">${i}</div>`;
        }

        html += `</div></div>`;
        calendarContainer.innerHTML = html;
    }

    const renderPlan = (date) => {
        renderCalendar(date);
        const dateStr = formatDateYMD(date);
        planContent.innerHTML = '';
        
        const today = new Date();
        today.setHours(0,0,0,0);

        let tasksForDay = studyPlan.tasks[dateStr] || [];
        let reviewsForDay = studyPlan.reviews[dateStr] || [];
        
        if (tasksForDay.length === 0 && reviewsForDay.length === 0) {
            planContent.innerHTML = `<div class="text-center p-4 bg-gray-50 rounded-lg"><p class="text-gray-500">Nenhuma tarefa agendada para hoje.</p></div>`;
            return;
        }

        if (tasksForDay.length > 0) {
            planContent.innerHTML += `<h3 class="text-lg font-semibold text-gray-700 mt-4 border-b pb-2">üìö Aulas do Dia</h3>`;
            tasksForDay.forEach(task => {
                const isOverdue = !task.completed && isBefore(new Date(task.date), today);
                planContent.appendChild(createTaskCard(task, isOverdue));
            });
        }

        if (reviewsForDay.length > 0) {
            planContent.innerHTML += `<h3 class="text-lg font-semibold text-gray-700 mt-6 border-b pb-2">üîÅ Revis√µes Agendadas</h3>`;
            reviewsForDay.forEach(review => {
                const isOverdue = !review.completed && isBefore(new Date(review.date), today);
                planContent.appendChild(createTaskCard(review, isOverdue));
            });
        }
    };

    function createTaskCard(task, isOverdue = false) {
        const card = document.createElement('div');
        let cardClasses = 'task-card p-4 rounded-lg shadow-sm';
        if (task.type.startsWith('review')) cardClasses += ` ${task.type}`;
        if (isOverdue) cardClasses += ' overdue';

        card.className = cardClasses;
        
        let geminiButtonsHTML = '';
         if (task.topic) {
            geminiButtonsHTML = `
            <div class="mt-3 pt-3 border-t border-gray-200 flex flex-wrap gap-2">
                <button class="gemini-button text-xs font-semibold py-1 px-3 rounded-full" data-action="explain" data-topic="${task.topic}">‚ú® Explicar T√≥pico</button>
                <button class="gemini-button text-xs font-semibold py-1 px-3 rounded-full" data-action="generate_questions" data-topic="${task.topic}">‚ú® Gerar Quest√µes</button>
            </div>
            `;
        }

        let title = task.type === 'study' ? `${task.subject} - Aula ${task.lesson}` : `${task.reviewType}: ${task.subject} - Aula ${task.lesson}`;

        card.innerHTML = `
            <div class="flex items-start space-x-4">
                <div class="flex-shrink-0 pt-1">
                    <input type="checkbox" id="${task.id}" data-id="${task.id}" data-date="${task.date}" data-type="${task.type}" class="task-checkbox h-5 w-5 rounded border-gray-300 text-[#D5A021] focus:ring-[#D5A021]" ${task.completed ? 'checked' : ''}>
                </div>
                <div class="flex-1">
                    <label for="${task.id}" class="cursor-pointer">
                        <p class="font-semibold text-gray-700">${title}</p>
                        <p class="text-gray-600 text-sm">${task.topic}</p>
                    </label>
                </div>
            </div>
            ${geminiButtonsHTML}
        `;
        return card;
    }

    function scheduleReviews(completedTask) {
        const completionDate = new Date(completedTask.date + 'T00:00:00');
        const reviewDays = { 'review-r1': 1, 'review-r3': 7, 'review-r5': 30 };

        for (const [reviewType, daysToAdd] of Object.entries(reviewDays)) {
            const reviewDate = addDays(completionDate, daysToAdd);
            const reviewDateStr = formatDateYMD(reviewDate);

            if (!studyPlan.reviews[reviewDateStr]) {
                studyPlan.reviews[reviewDateStr] = [];
            }
            
            const reviewId = `${completedTask.id}-${reviewType}`;
            
            if (studyPlan.reviews[reviewDateStr].some(r => r.id === reviewId)) continue;

            studyPlan.reviews[reviewDateStr].push({
                id: reviewId,
                date: reviewDateStr,
                subject: completedTask.subject,
                lesson: completedTask.lesson,
                topic: completedTask.topic,
                type: reviewType,
                reviewType: reviewType.replace('review-', '').toUpperCase(),
                completed: false,
            });
        }
    }
    
    const updateProgress = () => {
        const allTasks = Object.values(studyPlan.tasks).flat().concat(Object.values(studyPlan.reviews).flat());
        const completedTasks = allTasks.filter(task => task.completed).length;
        const totalTasks = allTasks.length;
        const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        progressText.textContent = `${percentage}%`;
        
        if (progressChart) {
            progressChart.data.datasets[0].data = [percentage, 100 - percentage];
            progressChart.update();
        }
    };

    const setupChart = () => {
        const ctx = document.getElementById('progressChart').getContext('2d');
        progressChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [0, 100],
                    backgroundColor: ['#D5A021', '#EAEAEA'],
                    borderColor: ['#FFFFFF'],
                    borderWidth: 4,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
    };
    
    async function callGemini(prompt, maxRetries = 3) {
        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Resposta da API inv√°lida ou vazia.");
                }
            } catch (error) {
                if (attempt === maxRetries - 1) return `Erro ao contatar o assistente de IA: ${error.message}. Por favor, tente novamente mais tarde.`;
                await new Promise(res => setTimeout(res, Math.pow(2, attempt) * 1000));
            }
        }
    }

    const handleGeminiAction = async (action, topic) => {
        geminiModal.classList.remove('hidden');
        modalLoading.style.display = 'block';
        modalContent.innerHTML = '';
        
        let prompt = '';
        if (action === 'explain') {
            modalTitle.textContent = `‚ú® Explicando: ${topic}`;
            prompt = `Com base no edital para Psic√≥logo da Prefeitura de Uberl√¢ndia (banca Consulplan), explique o seguinte t√≥pico de forma clara, objetiva e focada para concursos: "${topic}". Estruture a resposta com os pontos mais importantes.`;
        } else if (action === 'generate_questions') {
            modalTitle.textContent = `‚ú® Quest√µes sobre: ${topic}`;
            prompt = `Voc√™ √© um especialista na banca Consulplan. Elabore 3 quest√µes in√©ditas de m√∫ltipla escolha (A, B, C, D) sobre o t√≥pico "${topic}", seguindo o estilo de cobran√ßa da Consulplan para o concurso de Psic√≥logo da Prefeitura de Uberl√¢ndia. Ao final, apresente o gabarito comentado, explicando o porqu√™ de cada alternativa correta e incorreta.`;
        }
        const responseText = await callGemini(prompt);
        modalLoading.style.display = 'none';
        modalContent.innerHTML = responseText;
    };

    function renderAllTasksTable(filter = '') {
        const tableBody = document.getElementById('all-tasks-table-body');
        const allTasks = Object.values(studyPlan.tasks).flat();
        allTasks.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        let html = '';
        const filterText = filter.toLowerCase();

        allTasks.filter(task => {
            return task.subject.toLowerCase().includes(filterText) || task.topic.toLowerCase().includes(filterText);
        }).forEach(task => {
            html += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateDMY(new Date(task.date + 'T00:00:00'))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${task.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.lesson}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${task.topic}</td>
                </tr>
            `;
        });
        tableBody.innerHTML = html;
    }
    function renderOverdueTasks() {
      // Esconde o calend√°rio, j√° que estamos em uma visualiza√ß√£o de lista
      const calendarContainer = document.getElementById('calendar-container');
      if(calendarContainer) calendarContainer.innerHTML = '';
      
      // Limpa a √°rea de conte√∫do principal
      planContent.innerHTML = '';

      // Pega a data de hoje sem as horas para compara√ß√£o
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Junta todas as tarefas de estudo e revis√£o em uma √∫nica lista
      const allTasksAndReviews = Object.values(studyPlan.tasks).flat().concat(Object.values(studyPlan.reviews).flat());

      // Filtra para encontrar apenas as tarefas atrasadas (n√£o completas e com data anterior a hoje)
      const overdueTasks = allTasksAndReviews.filter(task => {
          const taskDate = new Date(task.date + 'T00:00:00');
          return !task.completed && taskDate < today;
      });

      // Ordena as tarefas da mais antiga para a mais nova
      overdueTasks.sort((a, b) => new Date(a.date) - new Date(b.date));

      // Cria um bot√£o para voltar √† visualiza√ß√£o do calend√°rio
      const backButton = document.createElement('button');
      backButton.innerHTML = '&#x2B05;&#xFE0F; Voltar ao Calend√°rio';
      backButton.className = 'control-button text-sm font-semibold py-2 px-4 rounded-lg shadow-sm mb-4';
      backButton.onclick = () => renderPlan(viewDate); // Re-renderiza a vis√£o normal
      planContent.appendChild(backButton);
      
      // Se n√£o houver tarefas atrasadas, mostra uma mensagem de parab√©ns
      if (overdueTasks.length === 0) {
          planContent.innerHTML += `<div class="text-center p-4 bg-green-50 rounded-lg border border-green-200"><p class="text-green-700 font-semibold">Parab√©ns! Nenhuma tarefa atrasada.</p></div>`;
          return;
      }
      
      // Se houver tarefas, mostra o t√≠tulo e a lista
      const title = document.createElement('h3');
      title.className = "text-lg font-semibold text-gray-700 mt-4 border-b pb-2 mb-4";
      title.textContent = `üö® ${overdueTasks.length} Tarefa(s) Atrasada(s)`;
      planContent.appendChild(title);

      // Cria e adiciona o card de cada tarefa atrasada na tela
      overdueTasks.forEach(task => {
          const taskCard = createTaskCard(task, true); // O 'true' for√ßa o estilo de atrasado
          planContent.appendChild(taskCard);
      });
  }
    planContent.addEventListener('change', (e) => {
        if (e.target.matches('.task-checkbox')) {
            const { id, date, type } = e.target.dataset;
            let taskList = type.startsWith('review') ? studyPlan.reviews[date] : studyPlan.tasks[date];
            const task = taskList.find(t => t.id === id);
            if (task) {
                task.completed = e.target.checked;
                if (task.type === 'study' && task.completed) {
                    scheduleReviews(task);
                }
                updateProgress();
                saveState();
                renderPlan(viewDate);
            }
        }
    });

    planContent.addEventListener('click', (e) => {
        if (e.target.closest('.gemini-button')) {
            const button = e.target.closest('.gemini-button');
            const action = button.dataset.action;
            const topic = button.dataset.topic;
            handleGeminiAction(action, topic);
        }
    });

    document.getElementById('calendar-container').addEventListener('click', (e) => {
        const dayElement = e.target.closest('.calendar-day');
        if (dayElement) {
            viewDate = new Date(dayElement.dataset.date + 'T00:00:00');
            renderPlan(viewDate);
        }
        if (e.target.id === 'prev-month') {
            viewDate.setMonth(viewDate.getMonth() - 1);
            renderPlan(viewDate);
        }
        if (e.target.id === 'next-month') {
            viewDate.setMonth(viewDate.getMonth() + 1);
            renderPlan(viewDate);
        }
    });

    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => {
            geminiModal.classList.add('hidden');
            allTasksModal.classList.add('hidden');
        });
    });

    const startCountdown = () => {
        const countdownEl = document.getElementById('countdown');
        const examDate = new Date('2025-10-26T08:00:00').getTime();
        const update = () => {
            const distance = examDate - new Date().getTime();
            if (distance < 0) {
                countdownEl.innerHTML = "PROVA REALIZADA!";
                clearInterval(interval);
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            countdownEl.innerHTML = `${days}d ${hours}h`;
        };
        const interval = setInterval(update, 1000 * 60 * 60);
        update();
    };

    document.getElementById('export-backup-btn').addEventListener('click', () => {
        const dataStr = JSON.stringify(studyPlan, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = 'backup_plano_estudos.json';
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    });
    
    document.getElementById('export-csv-btn').addEventListener('click', () => {
        let csvContent = "data:text/csv;charset=utf-8,date,subject,lesson,topic,type\n";
        const allTasks = Object.values(studyPlan.tasks).flat();
        allTasks.sort((a, b) => new Date(a.date) - new Date(b.date));
        allTasks.forEach(task => {
            const row = [task.date, `"${task.subject}"`, `"${task.lesson}"`, `"${task.topic}"`, task.type].join(',');
            csvContent += row + "\r\n";
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "base_de_aulas.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    document.getElementById('import-backup-btn').addEventListener('click', () => {
        document.getElementById('import-backup-file').click();
    });
    
    document.getElementById('import-csv-btn').addEventListener('click', () => {
        document.getElementById('import-csv-file').click();
    });
    
    document.getElementById('view-all-tasks-btn').addEventListener('click', () => {
        renderAllTasksTable();
        allTasksModal.classList.remove('hidden');
    });

    document.getElementById('all-tasks-search').addEventListener('input', (e) => {
        renderAllTasksTable(e.target.value);
    });

    document.getElementById('import-backup-file').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.tasks && importedData.reviews) {
                    studyPlan = importedData;
                    saveState();
                    renderPlan(viewDate);
                    updateProgress();
                    alert('Backup importado com sucesso!');
                } else {
                    alert('Arquivo de backup inv√°lido.');
                }
            } catch (err) {
                alert('Erro ao ler o arquivo de backup.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    });

    document.getElementById('import-csv-file').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const csv = e.target.result;
                const lines = csv.split('\n').slice(1); 
                let newTasksCount = 0;
                lines.forEach(line => {
                    if (line.trim() === '') return;
                    const [date, subject, lesson, topic, type] = line.split(',');
                    const task = { date: date.trim(), subject: subject.trim(), lesson: lesson.trim(), topic: topic.trim(), type: 'study' };
                    const id = generateUniqueId(task);
                    const dateStr = formatDateYMD(new Date(task.date + 'T00:00:00'));

                    if (!studyPlan.tasks[dateStr]) {
                        studyPlan.tasks[dateStr] = [];
                    }
                    
                    if (!studyPlan.tasks[dateStr].some(t => t.id === id)) {
                         studyPlan.tasks[dateStr].push({ ...task, id, completed: false });
                         newTasksCount++;
                    }
                });
                saveState();
                renderPlan(viewDate);
                updateProgress();
                alert(`${newTasksCount} novas aulas importadas com sucesso!`);

            } catch (err) {
                alert('Erro ao processar o arquivo CSV. Verifique o formato.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
        if (confirm('Tem certeza que deseja apagar todo o progresso? Esta a√ß√£o n√£o pode ser desfeita.')) {
            localStorage.removeItem(STORAGE_KEY);
            studyPlan = initializeStudyPlan();
            renderPlan(viewDate);
            updateProgress();
            alert('Progresso resetado.');
    document.getElementById('view-overdue-tasks-btn').addEventListener('click', renderOverdueTasks);
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
// Agora esperamos o loadState terminar antes de renderizar
await loadState(); 

renderPlan(viewDate);
setupChart();
updateProgress();
startCountdown();
document.getElementById('currentDate').textContent = formatDateDMY(new Date());
});
</script>
</body>
</html>

